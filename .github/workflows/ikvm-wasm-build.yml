name: IKVM WASM Build

env:
  EMSDK_VERSION: 3.1.56
  IKVM_REF: 8.14.0
  NATIVE_SDK_VERSION: "20251124.1"

on:
  push:
    branches:
      - master 
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        pthread_enabled: [true, false]
    runs-on: ubuntu-24.04
    name: Build IKVM artifacts (pthread=${{ matrix.pthread_enabled }})
    steps:
      - name: Check out source
        uses: actions/checkout@v4
      - name: Checkout IKVM source
        uses: actions/checkout@v4
        with:
          repository: ikvmnet/ikvm
          path: ikvm
          ref: ${{ env.IKVM_REF }}
          submodules: recursive
      - name: Apply IKVM patch
        shell: bash
        run: |
          cd ikvm
          git apply $GITHUB_WORKSPACE/ikvm.patch

      # -- same steps as IKVM.yml build-ikvm --
      - name: Uninstall Packages
        run: |
          sudo apt-get remove --purge -y \
            temurin-\* \
            mono-complete \
            unixodbc-dev \
            nginx \
            php\* \
            postgresql\* \
            python3-dev python3-pip python3-venv \
            ruby-full \
            firefox \
            apache2 \
            ant && \
          sudo apt-get --purge autoremove -y && \
          sudo apt-get clean && \
          sudo rm -rf /usr/share/swift
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          android: false
          swap-storage: false
      - name: Set Swap Space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 8
      - name: Install Powershell
        run: |
          sudo apt-get update && \
          sudo apt-get install -y powershell
      - name: Setup .NET 6.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x
      - name: Setup .NET 7.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 7.0.x
      - name: Setup .NET 8.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      - name: Setup .NET 10.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x
      - name: Install Mono
        run: |
          sudo apt-get update && \
          sudo apt-get install -y mono-runtime mono-devel
      - name: Install Java
        run: |
          sudo apt-get update && \
          sudo apt-get install -y openjdk-8-jdk-headless openjdk-21-jdk && \
          echo "JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64" >> $GITHUB_ENV
      - name: Install LLVM and Clang
        run: |
          sudo apt-get update && \
          sudo apt-get install -y clang-20 llvm-20 && \
          echo "PATH=/usr/lib/llvm-20/bin:$PATH" >> $GITHUB_ENV
      - name: Download Native SDKs
        uses: robinraju/release-downloader@v1.9
        with:
          repository: ikvmnet/ikvm-native-sdk
          tag: ${{ env.NATIVE_SDK_VERSION }}
          fileName: "*.tar.gz"
          out-file-path: ikvm/ext/ikvm-native-sdk
          extract: true
      - name: NuGet Restore
        shell: bash
        working-directory: ikvm
        run: dotnet restore IKVM.sln
      - name: Build IKVM
        shell: bash
        working-directory: ikvm
        run: |
          dotnet msbuild /m /bl \
            /p:Configuration="Release" \
            /p:Platform="Any CPU" \
            /p:BuildInParallel=true \
            /p:CreateHardLinksForAdditionalFilesIfPossible=true \
            /p:CreateHardLinksForCopyAdditionalFilesIfPossible=true \
            /p:CreateHardLinksForCopyFilesToOutputDirectoryIfPossible=true \
            /p:CreateHardLinksForCopyLocalIfPossible=true \
            /p:CreateHardLinksForPublishFilesIfPossible=true \
            /p:ContinuousIntegrationBuild=true \
            /p:ClangToolExe="/usr/bin/clang-20" \
            /p:LlvmArToolExe="/usr/bin/llvm-ar-20" \
            IKVM.sln

      # -- WASM native library build --
      - uses: mymindstorm/setup-emsdk@v14
        with:
          version: ${{ env.EMSDK_VERSION }}
      - name: Build WASM native artifacts
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p out/native/tmp

          PREFIX=""
          PTHREAD_FLAGS=()

          if [ "${{ matrix.pthread_enabled }}" = "false" ]; then
            PREFIX="ST-"
          else
            PTHREAD_FLAGS=( -pthread )
          fi

          LIBJVM_SRC="ikvm/src/libjvm"
          LIBIKVM_SRC="ikvm/src/libikvm"
          OPENJDK_DIR="ikvm/ext/openjdk"

          COMMON_DEFS=( -DTARGET_ARCH_x86 -DTARGET_OS_FAMILY_linux -DLINUX -D__int64='long long' )
          COMMON_INCLUDES=(
            -I"$LIBJVM_SRC"
            -I"$OPENJDK_DIR/hotspot/src/share/vm"
            -I"$OPENJDK_DIR/hotspot/src/share/vm/prims"
            -I"$OPENJDK_DIR/hotspot/src/cpu/x86/vm"
            -I"$OPENJDK_DIR/hotspot/src/os/linux/vm"
            -I"$OPENJDK_DIR/jdk/src/share/javavm/export"
            -I"$OPENJDK_DIR/jdk/src/solaris/javavm/export"
            -I"$OPENJDK_DIR/jdk/src/linux/javavm/export"
          )

          emcc -O2 -fPIC -fdeclspec "${PTHREAD_FLAGS[@]}" -c "$LIBJVM_SRC/jni.c" -o out/native/tmp/jni.o "${COMMON_DEFS[@]}" "${COMMON_INCLUDES[@]}"
          emcc -O2 -fPIC -fdeclspec "${PTHREAD_FLAGS[@]}" -c "$LIBJVM_SRC/jni_vargs.c" -o out/native/tmp/jni_vargs.o "${COMMON_DEFS[@]}" "${COMMON_INCLUDES[@]}"
          em++ -O2 -fPIC -std=c++11 -Wno-error -fdeclspec "${PTHREAD_FLAGS[@]}" -c "$LIBJVM_SRC/jvm.cpp" -o out/native/tmp/jvm.o "${COMMON_DEFS[@]}" "${COMMON_INCLUDES[@]}"
          emar rcs "out/native/${PREFIX}libjvm.a" out/native/tmp/jni.o out/native/tmp/jni_vargs.o out/native/tmp/jvm.o

          emcc -O2 -fPIC -DLINUX "${PTHREAD_FLAGS[@]}" -c "$LIBIKVM_SRC/dl.c" -o out/native/tmp/dl.o
          emcc -O2 -fPIC -DLINUX "${PTHREAD_FLAGS[@]}" -c "$LIBIKVM_SRC/sig.c" -o out/native/tmp/sig.o
          emar rcs "out/native/${PREFIX}libikvm.a" out/native/tmp/dl.o out/native/tmp/sig.o

      # -- bundle managed DLLs + WASM native libs --
      - name: Bundle artifacts
        shell: bash
        run: |
          set -euo pipefail

          PREFIX=""
          if [ "${{ matrix.pthread_enabled }}" = "false" ]; then
            PREFIX="ST-"
          fi

          mkdir -p out/release

          BYTECODE_DLL=$(find ~/.nuget/packages/ikvm.bytecode -name "IKVM.ByteCode.dll" -path "*/net8.0/*" | head -1)

          zip -j "out/release/ikvm-wasm-${PREFIX}bundle.zip" \
            ikvm/src/IKVM.Runtime/bin/Release/net8.0/IKVM.Runtime.dll \
            ikvm/src/IKVM.CoreLib/bin/Release/net8.0/IKVM.CoreLib.dll \
            ikvm/src/IKVM.Java/bin/Release/net8.0/IKVM.Java.dll \
            "$BYTECODE_DLL" \
            "out/native/${PREFIX}libjvm.a" \
            "out/native/${PREFIX}libikvm.a"
      - name: Archive artifacts (pthread=${{ matrix.pthread_enabled }})
        uses: actions/upload-artifact@v4
        with:
          name: ikvm-wasm-build-pthread-${{ matrix.pthread_enabled }}
          path: out/release/*.zip

  release:
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: write
    name: Create Release
    steps:
      - name: Generate release id
        run: echo RELEASE_NAME=$(uuidgen) >> $GITHUB_ENV

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Organize release assets
        shell: bash
        run: |
          mkdir release_assets
          find artifacts/ -type f | while read file; do
            cp "$file" release_assets/
          done

      - name: Create release
        uses: ncipollo/release-action@v1
        with:
          name: "IKVM WASM ${{ env.RELEASE_NAME }}"
          body: "These are the IKVM libs built for WASM (Emscripten)"
          commit: ${{ github.ref_name }}
          tag: ${{ env.RELEASE_NAME }}
          removeArtifacts: true
          artifacts: "release_assets/*"
          token: ${{ secrets.GITHUB_TOKEN }}
